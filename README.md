# ResNet20 Pruning
## Репозиторий:
  * **ResNet.py** - реализация модели ResNet20
  * **model.pth** - веса ResNet20 до прунинга
  * **first.py** - код первого метода
  * **second.py** - код второго метода
  * **tutorial.ipynb** - обрезка и тестировка моделей
## Первый метод:

Используя K-Means кластеризуем фильтры каждого сверточного слоя, таким образом получим центроиды кластеров (каждый центроид - фильтр). Используя вместо фильтров центроды удается сократить количесвто весов модели, но скорость её работы значительно падает, так как каждый сверточный слой теперь не хранит привычный nn.Conv2d, применение свертки к изображению происходит таким образом: i-ый фильтр в свертки сначала заменяется центроидом, к которму принадлежит, а только потом приментяется к изображению.

![image](https://user-images.githubusercontent.com/89237314/196045797-c7be578e-79b1-4308-83e4-b460ec527812.jpg)

На графике я привел время работы модели при увеличении сжатия (время засекалось на train части CIFAR10):

![compr_time_first](https://user-images.githubusercontent.com/89237314/196179443-cda55247-587b-46e6-b6af-d971ba24a2ac.png)

Количество параметров значительно упало, но работать модель стала медленнее:

![params](https://user-images.githubusercontent.com/89237314/196180043-4eac2092-fa25-4309-bf6e-28298eb22d5c.png)
### Точность
После урезания модели её точность ухудшилась, пришлось немного дообучить модель, чтобы оценить её точность

На графике приведена точность модель с коэффициентом сжатия 0.5:

![train_first_05](https://user-images.githubusercontent.com/89237314/196180580-40dabc14-5274-403c-801c-6318114bcb43.png)

Далее я поэксперементировал с размером модели. Урезал на 90% и снова дообучил:

![train_first_09](https://user-images.githubusercontent.com/89237314/196180779-f3c1c519-9336-4fe8-a3da-f140a4a0433b.png)

**Вывод:** Спустя несколько эпох точность модели возрасла на **55%** при том, что количество её весов в **10** раз меньше, чем у исходной модели ResNet20. 

## Второй метод:
Уменьшить количество весов удалось, но скорость из-за дополнительных операций упала. Было приянято решение отказаться от условия сохранения количества фильтров в каждом сверточном слое. Я решил применить кластеризацию к фильтрам первого сверточного слоя каждого residual блока, далее количство фильтров первого сверточного слоя изменялось, оставались только центроиды кластеров. Очевидно, что из-за изменения количесва фильтров feature map, которую принимает второй сверточный слой в residual блоке, имеет уже другие размеры. Таким образом, кроме уменьшения первого сверточного слоя, нужно уменьшить каждый фильтр второго сверточного слоя при этом запоминая, какие фильтры были обрезаны. Пример изменения residual блока я изобразил на картинке (красные цвета обозначают удаленные элементы)

![SecondModel](https://user-images.githubusercontent.com/89237314/196185868-02a3d3be-963c-4934-8bf4-cf869129d7e4.jpg)

Теперь при сжатии скорость модели росла. При урезании **80%** весов модель справлялась с тестовой частью CIFAR10 за **13.5** секунд, в свою очередь оригинальная ResNet20 делала это за **20.5** секунд:

![compr_time_second](https://user-images.githubusercontent.com/89237314/196188526-854202e9-3e42-4468-8006-f47c96e24f4c.png)

### Точность
Хоть скорость и возрасла, точность модели, после удаления большого количества слабых и сильных связей, заметно ухудшилась. Немного дообучив, модель мне удалось поднять её точность до 80% на тестовой выборке

На графиках приведена точность модели при разных коэфициентах сжатия:

![1train_second_05](https://user-images.githubusercontent.com/89237314/196205864-07c31b0b-402a-46df-a1da-da56373f9cd7.png)![1train_second_08](https://user-images.githubusercontent.com/89237314/196205891-66d0226e-ea0a-4922-8218-d3509aa61d47.png)

**Вывод:** Второй подход мне понравился больше, модель стала занимать меньше места, быстрее работать и обучаться

## Заключение:
Метод кластеризации фильтров с последующей их заменой на центроиды кластеров помог облегчить модель. Один из минусов - падение точности. Размышляя над проделанной работай и читая статьи на эту тему, я понял, что ключ к наименьшей потери точности кроится в составлении более качественных центроид. Я пользовался достаточно банальным методом, разворачивал фильтры в вектора, применял алгоритм K-means и сворачивал обратно. Уверен, это не самый лучший метод для обобщения фильтров в сверточном слое. Думаю перед тем как кластеризировать фильтры стоит уменьшить их размерность (например используя PCA), либо подумать о работе не с фильтром в целом, а с его ядрами свёртки, выкинуть наименее информативные (можно сравнить их по норме или применить SVD разложение для выделения наибольшее важных весов) 


